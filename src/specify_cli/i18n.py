"""Internationalization helper for Specify CLI."""
from __future__ import annotations

import os
from typing import Dict

DEFAULT_LANG = "en"
FALLBACK_LANG = "en"
ENV_VAR = "SPECIFY_LANG"

TRANSLATIONS: Dict[str, Dict[str, str]] = {
    "en": {
        "tagline": "GitHub Spec Kit - Spec-Driven Development Toolkit",
        "app_help": "Setup tool for Specify spec-driven development projects",
        "run_help_hint": "Run 'specify --help' for usage information",
        "init_command_help": "Initialize a new Specify project from the latest template.",
        "init_project_name_help": "Name for your new project directory (optional if using --here, or use '.' for current directory)",
        "init_ai_option_help": "AI assistant to use: claude, gemini, copilot, cursor-agent, qwen, opencode, codex, windsurf, kilocode, auggie, codebuddy, amp, or q",
        "init_script_option_help": "Script type to use: sh or ps",
        "init_ignore_agent_help": "Skip checks for AI agent tools like Claude Code",
        "init_no_git_help": "Skip git repository initialization",
        "init_here_help": "Initialize project in the current directory instead of creating a new one",
        "init_force_help": "Force merge/overwrite when using --here (skip confirmation)",
        "init_skip_tls_help": "Skip SSL/TLS verification (not recommended)",
        "init_debug_help": "Show verbose diagnostic output for network and extraction failures",
        "init_github_token_help": "GitHub token to use for API requests (or set GH_TOKEN or GITHUB_TOKEN environment variable)",
        "check_command_help": "Check that all required tools are installed.",
        "select_option_prompt": "Select an option",
        "selection_instructions": "Use ↑/↓ to navigate, Enter to select, Esc to cancel",
        "selection_cancelled": "Selection cancelled",
        "selection_failed": "Selection failed.",
        "project_setup": "Specify Project Setup",
        "project": "Project",
        "working_path": "Working Path",
        "target_path": "Target Path",
        "choose_ai_assistant": "Choose your AI assistant:",
        "choose_script_type": "Choose script type (or press Enter)",
        "selected_ai": "Selected AI assistant:",
        "selected_script": "Selected script type:",
        "script_choice_sh": "POSIX Shell (bash/zsh)",
        "script_choice_ps": "PowerShell",
        "error_both_project_and_here": "Cannot specify both project name and --here flag",
        "error_missing_project_name": "Must specify a project name, use '.' for current directory, or use --here flag",
    "error_label": "Error:",
        "warning_dir_not_empty": "Warning: Current directory is not empty ({count} items)",
        "warning_merge_overwrite": "Template files will be merged with existing content and may overwrite existing files",
        "force_skip_confirmation": "--force supplied: skipping confirmation and proceeding with merge",
        "confirm_continue_prompt": "Do you want to continue?",
        "operation_cancelled": "Operation cancelled",
        "directory_conflict_title": "Directory Conflict",
        "directory_conflict_body": "Directory {name} already exists\nPlease choose a different project name or remove the existing directory.",
        "git_missing_skip_init": "Git not found - will skip repository initialization",
        "invalid_ai_assistant": "Invalid AI assistant '{assistant}'. Choose from: {choices}",
        "invalid_script_type": "Invalid script type '{script}'. Choose from: {choices}",
        "agent_missing_title": "Agent Detection Error",
        "agent_missing_body": "{agent} not found\nInstall from: {install}\n{name} is required to continue with this project type.\n\nTip: Use {flag} to skip this check",
        "initialize_project": "Initialize Specify Project",
        "check_tools": "Check required tools",
        "select_ai": "Select AI assistant",
        "select_script": "Select script type",
        "fetch_release": "Fetch latest release",
        "download_template": "Download template",
        "extract_template": "Extract template",
        "archive_contents": "Archive contents",
        "extraction_summary": "Extraction summary",
        "ensure_executable": "Ensure scripts executable",
        "cleanup": "Cleanup",
        "init_git": "Initialize git repository",
        "finalize": "Finalize",
        "flatten_nested_directory": "Flatten nested directory",
        "status_ok": "ok",
        "status_existing_repo": "existing repo detected",
        "status_initialized": "initialized",
        "status_init_failed": "init failed",
        "status_git_unavailable": "git not available",
        "status_no_git_flag": "--no-git flag",
        "status_project_ready": "project ready",
        "project_ready_msg": "Project ready.",
        "initialization_failed": "Initialization failed",
        "failure_title": "Failure",
        "debug_env_title": "Debug Environment",
        "git_init_start": "Initializing git repository...",
        "git_init_success": "Git repository initialized",
        "git_init_error": "Error initializing git repository:",
        "git_init_failed_title": "Git Initialization Failed",
        "git_init_skipped": "Git repository initialization skipped:",
        "git_manual_init": "You can manually initialize git later with:",
        "agent_folder_security": "Agent Folder Security",
        "security_notice_msg": "Some agents may store credentials, auth tokens, or other identifying and private artifacts in the agent folder within your project.\nConsider adding {folder} (or parts of it) to .gitignore to prevent accidental credential leakage.",
        "next_steps": "Next Steps",
        "go_to_project": "Go to the project folder:",
        "already_in_directory": "You're already in the project directory!",
        "set_codex_home": "Set CODEX_HOME environment variable before running Codex:",
        "start_using_commands": "Start using slash commands with your AI agent:",
        "cmd_constitution": "Establish project principles",
        "cmd_specify": "Create baseline specification",
        "cmd_plan": "Create implementation plan",
        "cmd_tasks": "Generate actionable tasks",
        "cmd_implement": "Execute implementation",
        "enhancement_commands": "Enhancement Commands",
        "optional_commands_desc": "Optional commands that you can use for your specs (improve quality & confidence)",
        "optional": "optional",
        "cmd_clarify_desc": "Ask structured questions to de-risk ambiguous areas before planning (run before /speckit.plan if used)",
        "cmd_analyze_desc": "Cross-artifact consistency & alignment report (after /speckit.tasks, before /speckit.implement)",
        "cmd_checklist_desc": "Generate quality checklists to validate requirements completeness, clarity, and consistency (after /speckit.plan)",
        "check_tools_docstring": "Check that all required tools are installed.",
        "checking_tools": "Checking for installed tools...",
        "check_available_tools": "Check Available Tools",
        "git_version_control": "Git version control",
        "ide_based_no_cli": "IDE-based, no CLI check",
        "cli_ready": "Specify CLI is ready to use!",
        "tip_install_git": "Tip: Install git for repository management",
        "tip_install_assistant": "Tip: Install an AI assistant for the best experience",
        "cmd_error_running": "Error running command:",
        "cmd_exit_code": "Exit code:",
        "cmd_error_output": "Error output:",
        "settings_merged": "Merged:",
        "settings_copied_no_existing": "Copied (no existing settings.json):",
        "settings_merge_warning": "Warning: Could not merge, copying instead: {error}",
        "merged_json_file": "Merged JSON file:",
        "fetch_release_info": "Fetching latest release information...",
    "fetch_detail": "release {version} ({size} {unit})",
        "fetch_error_message": "Error fetching release information",
        "fetch_error_title": "Fetch Error",
        "no_matching_asset": "No matching release asset found",
        "asset_expected_pattern": "for [bold]{agent}[/bold] (expected pattern: [bold]{pattern}[/bold])",
        "no_assets_placeholder": "(no assets)",
        "available_assets_title": "Available Assets",
        "found_template": "Found template:",
        "template_size": "Size:",
        "bytes_unit": "bytes",
        "template_release": "Release:",
        "downloading_template": "Downloading template...",
    "progress_downloading": "Downloading...",
        "download_error_message": "Error downloading template",
        "download_error_title": "Download Error",
        "download_complete": "Downloaded: {filename}",
        "extracting_template": "Extracting template...",
        "zip_contains": "ZIP contains {count} items",
    "zip_entries_detail": "{count} entries",
    "temp_items_detail": "temp {count} items",
    "top_level_items_detail": "{count} top-level items",
        "extracted_to_temp": "Extracted {count} items to temp location",
        "found_nested_structure": "Found nested directory structure",
        "merging_directory": "Merging directory:",
        "overwriting_file": "Overwriting file:",
        "merged_into_current": "Template files merged into current directory",
        "extracted_to_path": "Extracted {count} items to {path}:",
        "dir_label": "dir",
        "file_label": "file",
        "flattened_structure": "Flattened nested directory structure",
        "extraction_error_message": "Error extracting template:",
        "extraction_error_title": "Extraction Error",
        "cleanup_archive": "Cleaned up: {name}",
        "cleanup_archive_step": "Remove temporary archive",
        "scripts_permissions_updated": "Updated execute permissions on {count} script(s) recursively",
        "scripts_update_failures": "Some scripts could not be updated:",
        "scripts_tracker_detail": "Updated {updated}",
        "scripts_tracker_detail_fail": "Updated {updated}, {failed} failed",
    },
    "zh_CN": {
        "tagline": "GitHub Spec Kit - 规范驱动开发工具包",
        "app_help": "Specify 规范驱动开发项目的设置工具",
        "run_help_hint": "运行 'specify --help' 查看使用说明",
        "init_command_help": "从最新模板初始化一个新的 Specify 项目。",
        "init_project_name_help": "新项目目录名称（使用 --here 时可选，或使用 '.' 表示当前目录）",
        "init_ai_option_help": "选择要使用的 AI 助手：claude、gemini、copilot、cursor-agent、qwen、opencode、codex、windsurf、kilocode、auggie、codebuddy、amp 或 q",
        "init_script_option_help": "选择脚本类型：sh 或 ps",
        "init_ignore_agent_help": "跳过对 Claude Code 等 AI 助手工具的检查",
        "init_no_git_help": "跳过 git 仓库初始化",
        "init_here_help": "在当前目录初始化项目，而不是创建新目录",
        "init_force_help": "在 --here 模式下强制合并/覆盖（跳过确认）",
        "init_skip_tls_help": "跳过 SSL/TLS 校验（不推荐）",
        "init_debug_help": "输出网络与解压故障的详细调试信息",
        "init_github_token_help": "用于 API 请求的 GitHub token（或设置 GH_TOKEN / GITHUB_TOKEN 环境变量）",
        "check_command_help": "检查是否安装了所有必需的工具。",
        "select_option_prompt": "请选择一个选项",
        "selection_instructions": "使用 ↑/↓ 选择，Enter 确认，Esc 取消",
        "selection_cancelled": "已取消选择",
        "selection_failed": "选择失败。",
        "project_setup": "Specify 项目设置",
        "project": "项目",
        "working_path": "工作路径",
        "target_path": "目标路径",
        "choose_ai_assistant": "选择您的 AI 助手：",
        "choose_script_type": "选择脚本类型（或按回车使用默认）",
        "selected_ai": "已选择 AI 助手:",
        "selected_script": "已选择脚本类型:",
        "script_choice_sh": "POSIX Shell（bash/zsh）",
        "script_choice_ps": "PowerShell",
        "error_both_project_and_here": "不能同时指定项目名称并使用 --here 标志",
        "error_missing_project_name": "必须指定项目名称、使用 '.' 表示当前目录或传入 --here",
    "error_label": "错误：",
        "warning_dir_not_empty": "警告：当前目录非空（{count} 个项目）",
        "warning_merge_overwrite": "模板文件将与现有内容合并，并可能覆盖现有文件",
        "force_skip_confirmation": "--force 已提供：跳过确认并继续合并",
        "confirm_continue_prompt": "要继续吗？",
        "operation_cancelled": "操作已取消",
        "directory_conflict_title": "目录冲突",
        "directory_conflict_body": "目录 {name} 已存在\n请选择其他项目名称或删除现有目录。",
        "git_missing_skip_init": "未找到 Git —— 将跳过仓库初始化",
        "invalid_ai_assistant": "无效的 AI 助手“{assistant}”。可选值：{choices}",
        "invalid_script_type": "无效的脚本类型“{script}”。可选值：{choices}",
        "agent_missing_title": "代理检测错误",
        "agent_missing_body": "{agent} 未找到\n安装地址：{install}\n{name} 是此项目类型的必需项。\n\n提示：使用 {flag} 可跳过该检查",
        "initialize_project": "初始化 Specify 项目",
        "check_tools": "检查必需工具",
        "select_ai": "选择 AI 助手",
        "select_script": "选择脚本类型",
        "fetch_release": "获取最新版本",
        "download_template": "下载模板",
        "extract_template": "解压模板",
        "archive_contents": "归档内容",
        "extraction_summary": "解压摘要",
        "ensure_executable": "确保脚本可执行",
        "cleanup": "清理",
        "init_git": "初始化 git 仓库",
        "finalize": "完成",
        "flatten_nested_directory": "扁平化嵌套目录",
        "status_ok": "完成",
        "status_existing_repo": "检测到现有仓库",
        "status_initialized": "已初始化",
        "status_init_failed": "初始化失败",
        "status_git_unavailable": "git 不可用",
        "status_no_git_flag": "--no-git 标志",
        "status_project_ready": "项目就绪",
        "project_ready_msg": "项目就绪。",
        "initialization_failed": "初始化失败",
        "failure_title": "失败",
        "debug_env_title": "调试环境",
        "git_init_start": "正在初始化 git 仓库...",
        "git_init_success": "git 仓库已初始化",
        "git_init_error": "初始化 git 仓库出错：",
        "git_init_failed_title": "Git 初始化失败",
        "git_init_skipped": "Git 仓库初始化已跳过:",
        "git_manual_init": "您可以稍后手动初始化 git:",
        "agent_folder_security": "代理文件夹安全",
        "security_notice_msg": "某些 AI 助手可能会在项目的代理文件夹中存储凭据、身份验证令牌或其他敏感信息。\n建议将 {folder}（或其部分内容）添加到 .gitignore 以防止意外泄露凭据。",
        "next_steps": "后续步骤",
        "go_to_project": "进入项目文件夹:",
        "already_in_directory": "您已经在项目目录中！",
        "set_codex_home": "在运行 Codex 前设置 CODEX_HOME 环境变量:",
        "start_using_commands": "开始使用 AI 助手的斜杠命令:",
        "cmd_constitution": "建立项目原则",
        "cmd_specify": "创建基准规范",
        "cmd_plan": "创建实施计划",
        "cmd_tasks": "生成可执行任务",
        "cmd_implement": "执行实施",
        "enhancement_commands": "增强命令",
        "optional_commands_desc": "可用于规范的可选命令（提高质量和可信度）",
        "optional": "可选",
        "cmd_clarify_desc": "在规划前询问结构化问题以降低模糊区域的风险（如使用请在 /speckit.plan 之前运行）",
        "cmd_analyze_desc": "跨工件一致性与对齐报告（在 /speckit.tasks 之后、/speckit.implement 之前）",
        "cmd_checklist_desc": "生成质量检查清单以验证需求的完整性、清晰度和一致性（在 /speckit.plan 之后）",
        "check_tools_docstring": "检查是否安装了所有必需的工具。",
        "checking_tools": "正在检查已安装的工具...",
        "check_available_tools": "检查可用工具",
        "git_version_control": "Git 版本控制",
        "ide_based_no_cli": "基于 IDE，无需 CLI 检查",
        "cli_ready": "Specify CLI 已就绪！",
        "tip_install_git": "提示: 安装 git 以进行仓库管理",
        "tip_install_assistant": "提示: 安装 AI 助手以获得最佳体验",
        "cmd_error_running": "运行命令出错：",
        "cmd_exit_code": "退出码：",
        "cmd_error_output": "错误输出：",
        "settings_merged": "已合并：",
        "settings_copied_no_existing": "已复制（不存在 settings.json）：",
        "settings_merge_warning": "警告：无法合并，改为复制：{error}",
        "merged_json_file": "已合并 JSON 文件：",
        "fetch_release_info": "正在获取最新发行版信息...",
    "fetch_detail": "版本 {version}（{size} {unit}）",
        "fetch_error_message": "获取发行版信息出错",
        "fetch_error_title": "获取错误",
        "no_matching_asset": "未找到匹配的发行版资源",
        "asset_expected_pattern": "对应 [bold]{agent}[/bold]（期望模式：[bold]{pattern}[/bold]）",
        "no_assets_placeholder": "（无资源）",
        "available_assets_title": "可用资源",
        "found_template": "已找到模板：",
        "template_size": "大小：",
        "bytes_unit": "字节",
        "template_release": "版本：",
        "downloading_template": "正在下载模板...",
    "progress_downloading": "正在下载...",
        "download_error_message": "下载模板出错",
        "download_error_title": "下载错误",
        "download_complete": "已下载：{filename}",
        "extracting_template": "正在解压模板...",
        "zip_contains": "ZIP 包含 {count} 个条目",
    "zip_entries_detail": "{count} 个条目",
    "temp_items_detail": "临时目录 {count} 个项目",
    "top_level_items_detail": "{count} 个顶层项目",
        "extracted_to_temp": "已解压 {count} 个项目到临时目录",
        "found_nested_structure": "检测到嵌套目录结构",
        "merging_directory": "正在合并目录：",
        "overwriting_file": "正在覆盖文件：",
        "merged_into_current": "模板文件已合并到当前目录",
        "extracted_to_path": "已解压 {count} 个项目到 {path}:",
        "dir_label": "目录",
        "file_label": "文件",
        "flattened_structure": "已扁平化嵌套目录结构",
        "extraction_error_message": "解压模板出错：",
        "extraction_error_title": "解压错误",
        "cleanup_archive": "已清理：{name}",
        "cleanup_archive_step": "删除临时压缩包",
        "scripts_permissions_updated": "已递归更新 {count} 个脚本的执行权限",
        "scripts_update_failures": "部分脚本无法更新：",
        "scripts_tracker_detail": "已更新 {updated}",
        "scripts_tracker_detail_fail": "已更新 {updated}，{failed} 个失败",
    },
}


def get_language() -> str:
    """Return the currently active language code."""
    lang = os.getenv(ENV_VAR, DEFAULT_LANG)
    return lang if lang in TRANSLATIONS else DEFAULT_LANG


def t(key: str, **kwargs) -> str:
    """Translate the specified key using the active language."""
    lang = get_language()
    template = TRANSLATIONS.get(lang, {}).get(key)
    if template is None:
        template = TRANSLATIONS.get(FALLBACK_LANG, {}).get(key, key)
    if kwargs:
        try:
            return template.format(**kwargs)
        except Exception:
            # If formatting fails, fall back to template
            return template
    return template


def available_languages() -> list[str]:
    """Return a list of available language codes."""
    return list(TRANSLATIONS.keys())
